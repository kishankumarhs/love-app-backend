version: '3.8'

services:
  # Load Balancer
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx-microservices.conf:/etc/nginx/nginx.conf
    depends_on:
      - api-gateway-1
      - api-gateway-2
    restart: unless-stopped

  # API Gateway Instances
  api-gateway-1:
    build:
      context: .
      dockerfile: Dockerfile.gateway
    environment:
      - NODE_ENV=production
      - PORT=3000
      - DATABASE_HOST=postgres-master
      - REDIS_HOST=redis-cluster
    depends_on:
      - postgres-master
      - redis-cluster
      - auth-service
      - notification-service
      - sos-service
    restart: unless-stopped

  api-gateway-2:
    build:
      context: .
      dockerfile: Dockerfile.gateway
    environment:
      - NODE_ENV=production
      - PORT=3000
      - DATABASE_HOST=postgres-master
      - REDIS_HOST=redis-cluster
    depends_on:
      - postgres-master
      - redis-cluster
      - auth-service
      - notification-service
      - sos-service
    restart: unless-stopped

  # Microservices
  auth-service:
    build:
      context: .
      dockerfile: Dockerfile.auth
    environment:
      - NODE_ENV=production
      - DATABASE_HOST=postgres-master
      - REDIS_HOST=redis-cluster
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      - postgres-master
      - redis-cluster
    deploy:
      replicas: 2
    restart: unless-stopped

  notification-service:
    build:
      context: .
      dockerfile: Dockerfile.notification
    environment:
      - NODE_ENV=production
      - DATABASE_HOST=postgres-master
      - REDIS_HOST=redis-cluster
    depends_on:
      - postgres-master
      - redis-cluster
    deploy:
      replicas: 2
    restart: unless-stopped

  sos-service:
    build:
      context: .
      dockerfile: Dockerfile.sos
    environment:
      - NODE_ENV=production
      - DATABASE_HOST=postgres-master
      - REDIS_HOST=redis-cluster
    depends_on:
      - postgres-master
      - redis-cluster
    deploy:
      replicas: 2
    restart: unless-stopped

  # Database Cluster
  postgres-master:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=loveapp
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
      - POSTGRES_REPLICATION_MODE=master
      - POSTGRES_REPLICATION_USER=replicator
      - POSTGRES_REPLICATION_PASSWORD=replicator_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_master_data:/var/lib/postgresql/data
      - ./postgresql.conf:/etc/postgresql/postgresql.conf
    command: postgres -c config_file=/etc/postgresql/postgresql.conf
    restart: unless-stopped

  postgres-replica-1:
    image: postgres:15-alpine
    environment:
      - POSTGRES_MASTER_SERVICE=postgres-master
      - POSTGRES_REPLICATION_MODE=slave
      - POSTGRES_REPLICATION_USER=replicator
      - POSTGRES_REPLICATION_PASSWORD=replicator_password
    volumes:
      - postgres_replica1_data:/var/lib/postgresql/data
    restart: unless-stopped

  postgres-replica-2:
    image: postgres:15-alpine
    environment:
      - POSTGRES_MASTER_SERVICE=postgres-master
      - POSTGRES_REPLICATION_MODE=slave
      - POSTGRES_REPLICATION_USER=replicator
      - POSTGRES_REPLICATION_PASSWORD=replicator_password
    volumes:
      - postgres_replica2_data:/var/lib/postgresql/data
    restart: unless-stopped

  # Redis Cluster
  redis-cluster:
    image: redis:7-alpine
    command: redis-server --appendonly yes --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000
    ports:
      - "6379:6379"
    volumes:
      - redis_cluster_data:/data
    restart: unless-stopped

  redis-node-1:
    image: redis:7-alpine
    command: redis-server --appendonly yes --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000
    volumes:
      - redis_node1_data:/data
    restart: unless-stopped

  redis-node-2:
    image: redis:7-alpine
    command: redis-server --appendonly yes --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000
    volumes:
      - redis_node2_data:/data
    restart: unless-stopped

volumes:
  postgres_master_data:
  postgres_replica1_data:
  postgres_replica2_data:
  redis_cluster_data:
  redis_node1_data:
  redis_node2_data: